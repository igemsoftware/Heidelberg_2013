{% extends "base.html" %}
{% load staticfiles %}

{% block js-include %}
<script src="{% static 'js/jquery.formset.js' %}"></script>
<script src="{% static 'js/jquery.panzoom.min.js' %}"></script>


{% endblock %}
{% block js %}
<script type="text/javascript">
    var modifis = [
        {% for mods in modifications %}
            {id: {{ forloop.counter0 }}, text: '{{ mods.name }}', mod_id:'{{key}}'}
        {% endfor %}
    ];
    var monomers = [
        {% for aa in substrates %}
            {id: {{ forloop.counter0 }}, text: '{{ aa.name }}', lid: {% firstof aa.L aa.D %}, did:  
                {% firstof aa.D aa.L %}, LChildren : [
                {% for child in aa.LChildren %}
                    {text : '{{ child.name }}', id : '{{child.pk}}'},
                {% endfor %}
            ],
            DChildren : [
                {% for child in aa.DChildren %}
                    {text : '{{ child.name }}', id : '{{child.pk}}'},
                {% endfor %}
            ]},
        {% endfor %}
    ];
    var animationDuration = 300;
    var structAR = 16 / 9;
    function getMonomers()
    {
        var ids = Array();
        var selected = jQuery('#selected_monomers :input[type="checkbox"]');
        for (var i = 0; i < selected.length; ++i) {
            ids[i] = jQuery(selected[i]).attr("value");
        }
        return ids;
    }
    function specifyModifications(e)
    {
//         var curM = jQuery(jQuery("#e23").data("currMonomer"));
//         var selectaa = jQuery('#e23');
        //var dataM = selectaa.select2("data");
        //alert(dataM.text);
        //var aa_id;
        
    }
    function makeStruct()
    {
        var ids = "?as=" + getMonomers().join("&as=");
        jQuery('#structimg').attr('src',"{% url 'Structure' %}" + ids);
    }
    function editMonomer(e)
    {
        jQuery("#selected_monomers input[type=checkbox]:checked").prop("checked", false).button("refresh");
        jQuery(e.delegateTarget).prop("checked", true).button("refresh");
        jQuery('#e23').select2("val", jQuery(e.delegateTarget).data("selectid"));
        jQuery("#e23").data("currMonomer", e.delegateTarget);
        var data = jQuery('#e23').select2("data");
        if (jQuery(e.target).attr("value") == data.lid) {
            jQuery("#monomer_chirality_L").click();
        } else {
            jQuery("#monomer_chirality_D").click();
        }
        jQuery("#monomer_chirality").buttonset("option", "disabled", data.lid == data.did);
    }
    function applyMonomer(e)
    {
        var btn = jQuery(jQuery("#e23").data("currMonomer"));
        var select = jQuery('#e23');
        var data = select.select2("data");
        var chiralityChildren;
        btn.button("option", "label", data.text);
        if (jQuery("#monomer_chirality :checked").val() == 'L') {
            btn.attr("value", data.lid);
            chiralityChildren = 'LChildren'
        } else {
            btn.attr("value", data.did);
            chiralityChildren = 'DChildren'
        }
        btn.data("selectid", data.id);

        jQuery("#monomer_chirality").buttonset("option", "disabled", data.lid == data.did);
        makeStruct();
        jQuery("#e11").select2({
              data: monomers[data.id][chiralityChildren],
              placeholder: "No modification selected",
              allowClear: true,
              });
    }
    function removeMonomer(e)
    {
        var monomer = jQuery(e.delegateTarget).parent();
        monomer.animate({width:0, opacity: 0}, animationDuration, function(){monomer.remove();});
        makeStruct();
    }
    function addMonomer(e)
    {
        var dflt = monomers[0];
        var close = jQuery("<button>", {html: 'delete'});
        var id =  new Date().getTime();
        var aa = jQuery('<input type="checkbox" value="' + dflt['lid'] + '" id="' + id + '"/>');
        var label = jQuery('<label for="' + id + '" style="margin-bottom:0px"/>'); //margin: conflict with bootstrap
        aa.data("selectid", dflt.id);
        var div = jQuery('<div>').css("display", "inline-block").css("vertical-align", "bottom").append(close).append(aa).append(label);
        close.button({icons: {primary: "ui-icon-close"}, text: false}).click(removeMonomer);
        aa.button({label: dflt['text']}).click(editMonomer);
        div.buttonset();
        div.hide();
        var selected = jQuery("#selected_monomers");
        selected.append(div);
        div.fadeIn(animationDuration);
        selected.animate({scrollLeft: selected[0].scrollWidth}, animationDuration);
        aa.click();
        jQuery("#struct").height(jQuery("#params").height());
        applyMonomer();
    }
    function formatAA(aminoAcid) {
        // if (!aminoAcid.id) return aminoAcid.text; // optgroup
        kek = "<img class='aminoAcid' height='50' width='50' src='{% url "Structure" %}"+  "?as=" + aminoAcid.lid + "'/>" + aminoAcid.text;
        return kek;
    }
    function submit(e)
    {
        jQuery.post("{% url 'submitNRP' %}", {as: getMonomers()}, undefined, "text").done(function(data){alert(data);}).fail(function(){alert("failed");});
    }

    jQuery(function() {
            var zoomMin = .1;
            var zoomMax = 5;
            var zoomStep = .1;
             jQuery("#e11").select2({
              data: [],
              placeholder: "No modification selected",
              allowClear: true,
              });
           jQuery("#e33").click(function(e){ jQuery('#basic-modal-content').modal();
                                 
                                 return false;
                                 });
           
            jQuery("#organisms").select2();
            jQuery("#e23").select2({data: monomers,
             formatResult: formatAA,
             dropdownCssClass: "bigdrop",
             escapeMarkup: function(m) { return m; }}).change(function(e){specifyModifications(e); applyMonomer(e);});
            jQuery("#monomer_chirality").buttonset().change(applyMonomer);
            jQuery("#monomer_add").button().click(addMonomer).click();
            jQuery("#submit").button().click(submit).parent().buttonset();
            jQuery("#structimg").panzoom({minScale:zoomMin, maxScale:zoomMax, contain: true});
            jQuery("#structzoom").slider({min:zoomMin, max:zoomMax, step:zoomStep, animation: "fast", orientation: "vertical", value: 1, slide: function(event, ui){jQuery("#structimg").panzoom("option", "contain", ui.value > 1 ? "invert" : true).panzoom("zoom", ui.value);}});
            jQuery("#structimg").load(function(e){
                var structimg = jQuery(e.delegateTarget);
               structimg.data("__pz__")._buildContain(); // update panzoom dimensions
            });
        });
</script>
{% endblock %}

{% block css-include %}
<style class="text/css">

	.box
	{	
		padding:10px;
		border:1px solid gray;
		margin:0px;
		border-top-left-radius: 10px;
		border-top-right-radius: 10px;	
		border-bottom-left-radius: 10px;
		border-bottom-right-radius: 10px;
	}

	.box:nth-of-type(2)
    {
        margin-top: 10px;
    }
	
	.pop-up_box1
	.pop-up_box2
	.pop-up_box3
	{
        background-clip: padding-box;
        background-color: #E4E4E4;
        background-image: -moz-linear-gradient(center top , #F4F4F4 20%, #F0F0F0 50%, #E8E8E8 52%, #EEEEEE 100%);
        border: 1px solid #AAAAAA;
        border-radius: 3px 3px 3px 3px;
        box-shadow: 0 0 2px #FFFFFF inset, 0 1px 0 rgba(0, 0, 0, 0.05);
        color: #333333;
        cursor: default;
        line-height: 13px;
        margin: 3px 0 3px 5px;
        padding: 3px 5px 3px 18px;
        position: relative;
	}
	
	.pop-up_box1 
	.pop-up_box2 
	{
        float: left;
        list-style: none outside none;
    }
    
    .pos_right
    {
        position:relative;
        right:-20px;
    }
</style>
{% endblock %}
{% block content %}
<h2>Welcome to the NRPS Designer Software provided by the iGEM Team Heidelberg 2013</h2>
</br>
<div class="row-fluid">
<div class="span8" id="params">
    <div class="box">
        <div id='basic-modal'>
        <p>Please choose an organism to express your non-ribosomal peptide!
            <a id="e33" href='#' style='color:#0040FF'>?</a></p>
        </div>
        <!-- modal content -->
        <div id="basic-modal-content">
            <h2>Basic Modal Dialog</h2>
        </div>
        <select id="organisms" size="1" style="width:100%">
            {% for origin in object_list %}
                <option value={{origin.source}}>{{origin.species}}</option>
            {% endfor %}
        </select>
    </div>
    <div class="box">
        <p> Please choose amino acids you want to integrate into your peptide! </p>
        <div id="e23" style="width:100%"></div>
        <div id="monomer_chirality">
            </br>
            <input type="radio" name="chirality" value="L" id="monomer_chirality_L" checked="checked"/><label for="monomer_chirality_L">L-configuration</label>
            <input type="radio" name="chirality" value="D" id="monomer_chirality_D"/><label for="monomer_chirality_D">D-configuration</label>
        </div>
        
        <div>
            </br>
            <p>Select a possible amino acid modification, if you like!</p> 
            <div id="e11" style="width:100%"></div>
        </div> 

        <div id="selected_monomers" style="white-space:nowrap;overflow:auto;margin-top:5px;margin-bottom:5px;padding-top:5px;padding-bottom:5px;"></div>
        <div>
        <button id="monomer_add">Add monomer</button><button id="submit">Submit</button></div>
    </div>
</div>

<div class="span4" id="struct">
    <div class="box" style="height:100%;-moz-box-sizing:border-box;box-sizing:border-box;">
            <div id="structzoom" style="float:left;height:100%;"></div>
            <div style="height:100%;text-align:center;">
                <img id="structimg" style="height:100%;">
            </div>
    </div>
</div>
    

{% endblock %}
